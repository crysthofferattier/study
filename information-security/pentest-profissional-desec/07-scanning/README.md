# Scanning

## 1. Route Recognition

### Traceroute

> More than 3s = * * *

```
traceroute www.example.com
traceroute to www.example.com (186.192.81.5), 30 hops max, 60 byte packets
 1  _gateway (10.0.2.2)  0.243 ms  0.125 ms  0.162 ms
 2  192.168.0.1 (192.168.0.1)  2.317 ms  6.373 ms  6.305 ms
 3  192.168.1.1 (192.168.1.1)  5.465 ms  5.414 ms  5.336 ms
 4  201.10.196.123 (201.10.196.123)  32.995 ms  36.769 ms  38.103 ms
 5  100.120.17.112 (100.120.17.112)  93.958 ms 100.120.16.142 (100.120.16.142)  72.626 ms 100.120.17.116 (100.120.17.116)  86.421 ms
 6  * * *
 7  * * *
 8  * * *
 9  * * *
10  * * *
11  * * *
12  * * *
13  * * *
14  * * *
15  * * *
16  * * *
17  * * *
18  * * *
19  * * *
20  * * *
21  * * *
22  * * *
23  * * *
24  * * *
25  * * *
26  * * *
27  * * *
28  * * *
29  * * *
30  * * *
```

* TTL: time to Live

```
ping 8.8.8.8
PING 8.8.8.8 (8.8.8.8) 56(84) bytes of data.
64 bytes from 8.8.8.8: icmp_seq=1 ttl=63 time=109 ms
64 bytes from 8.8.8.8: icmp_seq=2 ttl=63 time=108 ms
```

* **-m [ttl value]**: default value is **30**

> root@kali:~# traceroute www.example.com -m [ttl value]


```
root@kali:~# traceroute www.example.com -m 1
traceroute to www.example.com (186.192.81.5), 1 hops max, 60 byte packets
 1  _gateway (10.0.2.2)  0.328 ms  0.307 ms  0.192 ms

traceroute www.example.com -m 2
traceroute to www.example.com (186.192.81.5), 2 hops max, 60 byte packets
 1  _gateway (10.0.2.2)  0.352 ms  0.164 ms  0.193 ms
 2  192.168.0.1 (192.168.0.1)  2.979 ms  3.307 ms  3.207 ms

 						...
```

- **-f [ttl vle]**:

> root@kali:~# traceroute www.example.com -f [ttl value]

```
root@kali:~# traceroute www.example.com -f 4
traceroute to www.example.com (186.192.81.5), 30 hops max, 60 byte packets
 4  201.10.196.123 (201.10.196.123)  130.160 ms  137.834 ms  137.446 ms
 5  BrT-10G0-1-3-etpn-sp-rotb-j01.brasiltelecom.net.br (201.10.241.22)  139.183 ms etpn-sp-rotb-j01-xe-1-0-1.brasiltelecom.net.br (201.10.241.7)  156.751 ms 100.120.16.144 (100.120.16.144)  146.837 ms
 6  * * *
 7  * * *
 8  * * *
 9  * * *
10  * * *
11  * * *
								...
```

- **-n**: not resolving

```
root@kali:~# traceroute www.example.com -n
traceroute to www.example.com (186.192.81.5), 30 hops max, 60 byte packets
 1  10.0.2.2  0.500 ms  0.350 ms  0.255 ms
 2  192.168.0.1  2.434 ms  5.654 ms  5.611 ms
 3  192.168.1.1  5.866 ms  5.965 ms  5.888 ms
 4  201.10.196.123  41.114 ms  42.858 ms  53.689 ms
 5  201.10.241.234  76.656 ms 100.120.16.142  85.150 ms 201.10.241.234  83.991 ms
 6  * * *
 7  * * *
 8  * * *
 9  * * *
 								....
```

- **-I**: 3 ICMP pack

> root@kali:~# traceroute www.example.com -I

- **-T**: TCP pack

> root@kali:~# traceroute www.example.com -T

## 2. Search for active hosts with Ping

#### [active-hosts.sh](#)

### fping

> $ fping -g [hosts]/24

```
$ fping -g 192.168.0.1/24
$ fping -g 192.168.0.1/24 2> /dev/null
192.168.0.1 is alive
192.168.0.105 is alive
192.168.0.101 is alive
192.168.0.103 is alive
```

## 3. ICMP

```
root@kali:~# ping -c2 10.0.2.2
```

```
192.168.0.105.39738 > 192.168.0.104.22: Flags [.], cksum 0x8248 (incorrect -> 0x52aa), ack 553, win 356, options [nop,nop,TS val 2490009205 ecr 818955], length 0
20:19:34.281915 IP (tos 0x10, ttl 64, id 31505, offset 0, flags [DF], proto TCP (6), length 108)
    192.168.0.104.22 > 192.168.0.105.39738: Flags [P.], cksum 0x4c95 (correct), seq 553:609, ack 160, win 515, options [nop,nop,TS val 818955 ecr 2490009205], length 56
20:19:34.281925 IP (tos 0x10, ttl 64, id 57280, offset 0, flags [DF], proto TCP (6), length 52)
```

```
root@kali:~# man icmp
```

### Firewall rules

Metasploitable vm

> DROP ICMP echo request

```
$ iptables -F
$ iptables -A INPUT -p icmp --icmp-type 8 -d [host] -j DROP
$ ping -c1 [host]
```

> REJECT ICMP echo request

```
$ iptables -F
$ iptables -A INPUT -p icmp --icmp-type 8 -d [host] -j REJECT
$ ping -c1 [host]
```

## 3. E quando o ping nÃ£o funciona

```
$ nmap -sn -v 192.168.0.104

Starting Nmap 7.01 ( https://nmap.org ) at 2018-03-07 18:47 -04
Initiating Ping Scan at 18:47
Scanning 192.168.0.104 [2 ports]
Completed Ping Scan at 18:47, 0.00s elapsed (1 total hosts)
Initiating Parallel DNS resolution of 1 host. at 18:47
Completed Parallel DNS resolution of 1 host. at 18:47, 0.10s elapsed
Nmap scan report for 192.168.0.104
Host is up (0.00056s latency).
Read data files from: /usr/bin/../share/nmap
Nmap done: 1 IP address (1 host up) scanned in 0.10 seconds
```

## 4. Flags TCP

| Flag | Description |
|-|-|
| SYN | synchronize |
| ACK | acknowledgement |
| SYN-ACK |
| FIN | Finalize |
| RST | RESET |

## 5. Port Scanning

> $ hping3 --syn -c1 -p [port] [host]


* Flag **SA**: SYN/ACK (open port)

```
$ sudo hping3 --syn -c 1 -p 80 www.example.com
HPING www.example.com (wlp3s0 37.59.174.225): S set, 40 headers + 0 data bytes
len=44 ip=37.59.174.225 ttl=47 DF id=0 sport=80 flags=SA seq=0 win=14600 rtt=607.7 ms

--- www.example.com hping statistic ---
1 packets transmitted, 1 packets received, 0% packet loss
round-trip min/avg/max = 607.7/607.7/607.7 ms

```
> $ sudo nmap -v -sS -p 80 www.example.com

* Flag **RA**: RST/ACK (closed port)

```
$ sudo hping3 --syn -c 1 -p 80 www.example.com

HPING www.example.com (wlp3s0 37.59.174.225): S set, 40 headers + 0 data bytes
len=40 ip=37.59.174.225 ttl=48 DF id=39375 sport=81 flags=RA seq=0 win=0 rtt=459.8 ms

--- www.example.com hping statistic ---
1 packets transmitted, 1 packets received, 0% packet loss
round-trip min/avg/max = 459.8/459.8/459.8 ms
```
> $ sudo nmap -v -sS -p 81 www.example.com

* Metasploitable vm

> REJECT ICMP echo request

##### Metasploitable vm
* 1
```
$ iptables -F
$ iptables -A INPUT -p tcp --dport 80 -j REJECT
```

* 2
```
$ iptables -F
$ iptables -A INPUT -p tcp --dport 80 -j DROP
```

* 3
```
$ iptables -F
$ iptables -A INPUT -p tcp --dport 80 -j REJECT --reject-with tcp-reset
```

##### Kali Linux

* 1
```
$ sudo hping3 --syn -c 1 -p 80 192.168.0.104
HPING 192.168.0.104 (wlp3s0 192.168.0.104): S set, 40 headers + 0 data bytes
ICMP Port Unreachable from ip=192.168.0.104 name=UNKNOWN   

--- 192.168.0.104 hping statistic ---
1 packets transmitted, 1 packets received, 0% packet loss
round-trip min/avg/max = 0.0/0.0/0.0 ms

```

```
$ sudo nmap -v -sS -p 80 192.168.0.104

Starting Nmap 7.01 ( https://nmap.org ) at 2018-03-08 18:47 -04
Initiating ARP Ping Scan at 18:47
Scanning 192.168.0.104 [1 port]
Completed ARP Ping Scan at 18:47, 0.23s elapsed (1 total hosts)
Initiating Parallel DNS resolution of 1 host. at 18:47
Completed Parallel DNS resolution of 1 host. at 18:47, 1.48s elapsed
Initiating SYN Stealth Scan at 18:47
Scanning 192.168.0.104 [1 port]
Completed SYN Stealth Scan at 18:47, 0.23s elapsed (1 total ports)
Nmap scan report for 192.168.0.104
Host is up (0.00040s latency).
PORT   STATE    SERVICE
80/tcp filtered http
MAC Address: 08:00:27:3B:13:69 (Oracle VirtualBox virtual NIC)

Read data files from: /usr/bin/../share/nmap
Nmap done: 1 IP address (1 host up) scanned in 2.10 seconds
           Raw packets sent: 3 (116B) | Rcvd: 3 (172B)
```

* 2

> **NO answer**

```
$ sudo hping3 --syn -c 1 -p 80 192.168.0.104
HPING 192.168.0.104 (wlp3s0 192.168.0.104): S set, 40 headers + 0 data bytes

--- 192.168.0.104 hping statistic ---
1 packets transmitted, 0 packets received, 100% packet loss
round-trip min/avg/max = 0.0/0.0/0.0 ms
```

```
$ sudo nmap -v -sS -p 80 192.168.0.104

Starting Nmap 7.01 ( https://nmap.org ) at 2018-03-08 18:50 -04
Initiating ARP Ping Scan at 18:50
Scanning 192.168.0.104 [1 port]
Completed ARP Ping Scan at 18:50, 0.24s elapsed (1 total hosts)
Initiating Parallel DNS resolution of 1 host. at 18:50
Completed Parallel DNS resolution of 1 host. at 18:50, 0.15s elapsed
Initiating SYN Stealth Scan at 18:50
Scanning 192.168.0.104 [1 port]
Completed SYN Stealth Scan at 18:50, 0.26s elapsed (1 total ports)
Nmap scan report for 192.168.0.104
Host is up (0.00044s latency).
PORT   STATE    SERVICE
80/tcp filtered http
MAC Address: 08:00:27:3B:13:69 (Oracle VirtualBox virtual NIC)

Read data files from: /usr/bin/../share/nmap
Nmap done: 1 IP address (1 host up) scanned in 0.82 seconds
           Raw packets sent: 3 (116B) | Rcvd: 1 (28B)
```

* 3
```
$ sudo hping3 --syn -c 1 -p 80 192.168.0.104
HPING 192.168.0.104 (wlp3s0 192.168.0.104): S set, 40 headers + 0 data bytes
len=40 ip=192.168.0.104 ttl=64 DF id=0 sport=80 flags=RA seq=0 win=0 rtt=7.8 ms

--- 192.168.0.104 hping statistic ---
1 packets transmitted, 1 packets received, 0% packet loss
round-trip min/avg/max = 7.8/7.8/7.8 ms
```

```
$ sudo nmap -v -sS -p 80 192.168.0.104

Starting Nmap 7.01 ( https://nmap.org ) at 2018-03-08 18:53 -04
Initiating ARP Ping Scan at 18:53
Scanning 192.168.0.104 [1 port]
Completed ARP Ping Scan at 18:53, 0.24s elapsed (1 total hosts)
Initiating Parallel DNS resolution of 1 host. at 18:53
Completed Parallel DNS resolution of 1 host. at 18:53, 0.05s elapsed
Initiating SYN Stealth Scan at 18:53
Scanning 192.168.0.104 [1 port]
Completed SYN Stealth Scan at 18:53, 0.22s elapsed (1 total ports)
Nmap scan report for 192.168.0.104
Host is up (0.00041s latency).
PORT   STATE  SERVICE
80/tcp closed http
MAC Address: 08:00:27:3B:13:69 (Oracle VirtualBox virtual NIC)

Read data files from: /usr/bin/../share/nmap
Nmap done: 1 IP address (1 host up) scanned in 0.62 seconds
           Raw packets sent: 3 (116B) | Rcvd: 3 (108B)
```

### Summary

| Status | - |
| - | - |
| Open | SYN/ACK (flag[**SA**]) |
| Closed | rst/ACK (flag[**RA**]) |
| Drop | NO answer |
| Reject | Port Unreachable |
| RST | RST |

## 6. Portscan types

### Three Way Handshake

| - | - | - |
| - | - | - |
| Client | ------ SYN ------> | Server |
| Client | <---- SYN/ACK ---- | Server |
| Client | ------ ACK ------> | Server |

### TCP Connect

Complete three way handshake

```
$ nmap -sT
$ nmap -sV (determine service/version info)
```

### Half Open/SYN Connect

Does not complete the three way hanshake

```
$ nmap -sS
```

| - | - | - |
| - | - | - |
| Client | ------ SYN ------> | Server |
| Client | <---- SYN/ACK ---- | Server |
| Client | ------ RST ------> | Server |

## 7. Nmap

### Options

| Flag | Description |
| - | - |
| -sn | detection of live hosts |
| -sT | TCP Connect |
| -sS | SYN Scan/Half Open |
| -sV | Version detection |
| -sU | UDP Scan |
| -Pn |  No host ping |
| -O |  OS details|
| -A | OS and services details |
| -p | port |
| -sF | FIN scan |
| -sN | NULL scan |
| -sX | XMAS scan |
| -f | fragm. packages |
| --open | Open ports |
| -oN | Output file |
| -oX | Output xml file |
| -oG | Output grep file |

### Level

| Level | Description |
| - | - |
| -T0 | prevent IDS |
| -T1 | sleep 15s |
| -T2 | sleep 4s |
| -T3 | Normal scan |
| -T4 | Fast scan |
| -T5 | More fast scan |

