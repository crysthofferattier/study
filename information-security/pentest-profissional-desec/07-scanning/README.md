# Scanning

## 1. Route Recognition

### Traceroute

> More than 3s = * * *

```
traceroute www.example.com
traceroute to www.example.com (186.192.81.5), 30 hops max, 60 byte packets
 1  _gateway (10.0.2.2)  0.243 ms  0.125 ms  0.162 ms
 2  192.168.0.1 (192.168.0.1)  2.317 ms  6.373 ms  6.305 ms
 3  192.168.1.1 (192.168.1.1)  5.465 ms  5.414 ms  5.336 ms
 4  201.10.196.123 (201.10.196.123)  32.995 ms  36.769 ms  38.103 ms
 5  100.120.17.112 (100.120.17.112)  93.958 ms 100.120.16.142 (100.120.16.142)  72.626 ms 100.120.17.116 (100.120.17.116)  86.421 ms
 6  * * *
 7  * * *
 8  * * *
 9  * * *
10  * * *
11  * * *
12  * * *
13  * * *
14  * * *
15  * * *
16  * * *
17  * * *
18  * * *
19  * * *
20  * * *
21  * * *
22  * * *
23  * * *
24  * * *
25  * * *
26  * * *
27  * * *
28  * * *
29  * * *
30  * * *
```

* TTL: time to Live

```
ping 8.8.8.8
PING 8.8.8.8 (8.8.8.8) 56(84) bytes of data.
64 bytes from 8.8.8.8: icmp_seq=1 ttl=63 time=109 ms
64 bytes from 8.8.8.8: icmp_seq=2 ttl=63 time=108 ms
```

* **-m [ttl value]**: default value is **30**

> root@kali:~# traceroute www.example.com -m [ttl value]


```
root@kali:~# traceroute www.example.com -m 1
traceroute to www.example.com (186.192.81.5), 1 hops max, 60 byte packets
 1  _gateway (10.0.2.2)  0.328 ms  0.307 ms  0.192 ms

traceroute www.example.com -m 2
traceroute to www.example.com (186.192.81.5), 2 hops max, 60 byte packets
 1  _gateway (10.0.2.2)  0.352 ms  0.164 ms  0.193 ms
 2  192.168.0.1 (192.168.0.1)  2.979 ms  3.307 ms  3.207 ms

 						...
```

- **-f [ttl vle]**:

> root@kali:~# traceroute www.example.com -f [ttl value]

```
root@kali:~# traceroute www.example.com -f 4
traceroute to www.example.com (186.192.81.5), 30 hops max, 60 byte packets
 4  201.10.196.123 (201.10.196.123)  130.160 ms  137.834 ms  137.446 ms
 5  BrT-10G0-1-3-etpn-sp-rotb-j01.brasiltelecom.net.br (201.10.241.22)  139.183 ms etpn-sp-rotb-j01-xe-1-0-1.brasiltelecom.net.br (201.10.241.7)  156.751 ms 100.120.16.144 (100.120.16.144)  146.837 ms
 6  * * *
 7  * * *
 8  * * *
 9  * * *
10  * * *
11  * * *
								...
```

- **-n**: not resolving

```
root@kali:~# traceroute www.example.com -n
traceroute to www.example.com (186.192.81.5), 30 hops max, 60 byte packets
 1  10.0.2.2  0.500 ms  0.350 ms  0.255 ms
 2  192.168.0.1  2.434 ms  5.654 ms  5.611 ms
 3  192.168.1.1  5.866 ms  5.965 ms  5.888 ms
 4  201.10.196.123  41.114 ms  42.858 ms  53.689 ms
 5  201.10.241.234  76.656 ms 100.120.16.142  85.150 ms 201.10.241.234  83.991 ms
 6  * * *
 7  * * *
 8  * * *
 9  * * *
 								....
```

- **-I**: 3 ICMP pack

> root@kali:~# traceroute www.example.com -I

- **-T**: TCP pack

> root@kali:~# traceroute www.example.com -T

## 2. Search for active hosts with Ping

#### [active-hosts.sh](#)

### fping

> $ fping -g [hosts]/24

```
$ fping -g 192.168.0.1/24
$ fping -g 192.168.0.1/24 2> /dev/null
192.168.0.1 is alive
192.168.0.105 is alive
192.168.0.101 is alive
192.168.0.103 is alive
```

## 3. ICMP

```
root@kali:~# ping -c2 10.0.2.2
```

```
192.168.0.105.39738 > 192.168.0.104.22: Flags [.], cksum 0x8248 (incorrect -> 0x52aa), ack 553, win 356, options [nop,nop,TS val 2490009205 ecr 818955], length 0
20:19:34.281915 IP (tos 0x10, ttl 64, id 31505, offset 0, flags [DF], proto TCP (6), length 108)
    192.168.0.104.22 > 192.168.0.105.39738: Flags [P.], cksum 0x4c95 (correct), seq 553:609, ack 160, win 515, options [nop,nop,TS val 818955 ecr 2490009205], length 56
20:19:34.281925 IP (tos 0x10, ttl 64, id 57280, offset 0, flags [DF], proto TCP (6), length 52)
```

```
root@kali:~# man icmp
```

### Firewall rules

Metasploitable vm

> DROP ICMP echo request

```
$ iptables -F
$ iptables -A INPUT -p icmp --icmp-type 8 -d [host] -j DROP
$ ping -c1 [host]
```

> REJECT ICMP echo request

```
$ iptables -F
$ iptables -A INPUT -p icmp --icmp-type 8 -d [host] -j REJECT
$ ping -c1 [host]
```

## 3. E quando o ping nÃ£o funciona

```
$ nmap -sn -v 192.168.0.104

Starting Nmap 7.01 ( https://nmap.org ) at 2018-03-07 18:47 -04
Initiating Ping Scan at 18:47
Scanning 192.168.0.104 [2 ports]
Completed Ping Scan at 18:47, 0.00s elapsed (1 total hosts)
Initiating Parallel DNS resolution of 1 host. at 18:47
Completed Parallel DNS resolution of 1 host. at 18:47, 0.10s elapsed
Nmap scan report for 192.168.0.104
Host is up (0.00056s latency).
Read data files from: /usr/bin/../share/nmap
Nmap done: 1 IP address (1 host up) scanned in 0.10 seconds
```

## 4. Flags TCP

| Flag | Description |
|-|-|
| SYN | synchronize |
| ACK | acknowledgement |
| SYN-ACK |
| FIN | Finalize |
| RST | RESET |

## 5. Port Scanning

> $ hping3 --syn -c1 -p [port] [host]


* Flag **SA**: SYN/ACK (open port)

```
$ hping3 --syn -c 1 -p 80 www.example.com
HPING www.example.com (wlp3s0 37.59.174.225): S set, 40 headers + 0 data bytes
len=44 ip=37.59.174.225 ttl=47 DF id=0 sport=80 flags=SA seq=0 win=14600 rtt=607.7 ms

--- www.example.com hping statistic ---
1 packets transmitted, 1 packets received, 0% packet loss
round-trip min/avg/max = 607.7/607.7/607.7 ms

```
> $ nmap -v -sS -p 80 www.example.com

* Flag **RA**: RST/ACK (closed port)

```
$ hping3 --syn -c 1 -p 80 www.example.com

HPING www.example.com (wlp3s0 37.59.174.225): S set, 40 headers + 0 data bytes
len=40 ip=37.59.174.225 ttl=48 DF id=39375 sport=81 flags=RA seq=0 win=0 rtt=459.8 ms

--- www.example.com hping statistic ---
1 packets transmitted, 1 packets received, 0% packet loss
round-trip min/avg/max = 459.8/459.8/459.8 ms
```
> $ nmap -v -sS -p 81 www.example.com

* Metasploitable vm

> REJECT ICMP echo request

##### Metasploitable vm
* 1
```
$ iptables -F
$ iptables -A INPUT -p tcp --dport 80 -j REJECT
```

* 2
```
$ iptables -F
$ iptables -A INPUT -p tcp --dport 80 -j DROP
```

* 3
```
$ iptables -F
$ iptables -A INPUT -p tcp --dport 80 -j REJECT --reject-with tcp-reset
```

##### Kali Linux

* 1
```
$ hping3 --syn -c 1 -p 80 192.168.0.104
HPING 192.168.0.104 (wlp3s0 192.168.0.104): S set, 40 headers + 0 data bytes
ICMP Port Unreachable from ip=192.168.0.104 name=UNKNOWN   

--- 192.168.0.104 hping statistic ---
1 packets transmitted, 1 packets received, 0% packet loss
round-trip min/avg/max = 0.0/0.0/0.0 ms

```

```
$ nmap -v -sS -p 80 192.168.0.104

Starting Nmap 7.01 ( https://nmap.org ) at 2018-03-08 18:47 -04
Initiating ARP Ping Scan at 18:47
Scanning 192.168.0.104 [1 port]
Completed ARP Ping Scan at 18:47, 0.23s elapsed (1 total hosts)
Initiating Parallel DNS resolution of 1 host. at 18:47
Completed Parallel DNS resolution of 1 host. at 18:47, 1.48s elapsed
Initiating SYN Stealth Scan at 18:47
Scanning 192.168.0.104 [1 port]
Completed SYN Stealth Scan at 18:47, 0.23s elapsed (1 total ports)
Nmap scan report for 192.168.0.104
Host is up (0.00040s latency).
PORT   STATE    SERVICE
80/tcp filtered http
MAC Address: 08:00:27:3B:13:69 (Oracle VirtualBox virtual NIC)

Read data files from: /usr/bin/../share/nmap
Nmap done: 1 IP address (1 host up) scanned in 2.10 seconds
           Raw packets sent: 3 (116B) | Rcvd: 3 (172B)
```

* 2

> **NO answer**

```
$ hping3 --syn -c 1 -p 80 192.168.0.104
HPING 192.168.0.104 (wlp3s0 192.168.0.104): S set, 40 headers + 0 data bytes

--- 192.168.0.104 hping statistic ---
1 packets transmitted, 0 packets received, 100% packet loss
round-trip min/avg/max = 0.0/0.0/0.0 ms
```

```
$ nmap -v -sS -p 80 192.168.0.104

Starting Nmap 7.01 ( https://nmap.org ) at 2018-03-08 18:50 -04
Initiating ARP Ping Scan at 18:50
Scanning 192.168.0.104 [1 port]
Completed ARP Ping Scan at 18:50, 0.24s elapsed (1 total hosts)
Initiating Parallel DNS resolution of 1 host. at 18:50
Completed Parallel DNS resolution of 1 host. at 18:50, 0.15s elapsed
Initiating SYN Stealth Scan at 18:50
Scanning 192.168.0.104 [1 port]
Completed SYN Stealth Scan at 18:50, 0.26s elapsed (1 total ports)
Nmap scan report for 192.168.0.104
Host is up (0.00044s latency).
PORT   STATE    SERVICE
80/tcp filtered http
MAC Address: 08:00:27:3B:13:69 (Oracle VirtualBox virtual NIC)

Read data files from: /usr/bin/../share/nmap
Nmap done: 1 IP address (1 host up) scanned in 0.82 seconds
           Raw packets sent: 3 (116B) | Rcvd: 1 (28B)
```

* 3
```
$ hping3 --syn -c 1 -p 80 192.168.0.104
HPING 192.168.0.104 (wlp3s0 192.168.0.104): S set, 40 headers + 0 data bytes
len=40 ip=192.168.0.104 ttl=64 DF id=0 sport=80 flags=RA seq=0 win=0 rtt=7.8 ms

--- 192.168.0.104 hping statistic ---
1 packets transmitted, 1 packets received, 0% packet loss
round-trip min/avg/max = 7.8/7.8/7.8 ms
```

```
$ nmap -v -sS -p 80 192.168.0.104

Starting Nmap 7.01 ( https://nmap.org ) at 2018-03-08 18:53 -04
Initiating ARP Ping Scan at 18:53
Scanning 192.168.0.104 [1 port]
Completed ARP Ping Scan at 18:53, 0.24s elapsed (1 total hosts)
Initiating Parallel DNS resolution of 1 host. at 18:53
Completed Parallel DNS resolution of 1 host. at 18:53, 0.05s elapsed
Initiating SYN Stealth Scan at 18:53
Scanning 192.168.0.104 [1 port]
Completed SYN Stealth Scan at 18:53, 0.22s elapsed (1 total ports)
Nmap scan report for 192.168.0.104
Host is up (0.00041s latency).
PORT   STATE  SERVICE
80/tcp closed http
MAC Address: 08:00:27:3B:13:69 (Oracle VirtualBox virtual NIC)

Read data files from: /usr/bin/../share/nmap
Nmap done: 1 IP address (1 host up) scanned in 0.62 seconds
           Raw packets sent: 3 (116B) | Rcvd: 3 (108B)
```

### Summary

| Status | - |
| - | - |
| Open | SYN/ACK (flag[**SA**]) |
| Closed | rst/ACK (flag[**RA**]) |
| Drop | NO answer |
| Reject | Port Unreachable |
| RST | RST |

## 6. Portscan types

### Three Way Handshake

| - | - | - |
| - | - | - |
| Client | ------ SYN ------> | Server |
| Client | <---- SYN/ACK ---- | Server |
| Client | ------ ACK ------> | Server |

### TCP Connect

Complete three way handshake

```
$ nmap -sT
$ nmap -sV (determine service/version info)
```

### Half Open/SYN Connect

Does not complete the three way hanshake

```
$ nmap -sS
```

| - | - | - |
| - | - | - |
| Client | ------ SYN ------> | Server |
| Client | <---- SYN/ACK ---- | Server |
| Client | ------ RST ------> | Server |

## 7. Nmap

<<<<<<< HEAD
### Nmap Help

```
Nmap 7.01 ( https://nmap.org )
Usage: nmap [Scan Type(s)] [Options] {target specification}
TARGET SPECIFICATION:
  Can pass hostnames, IP addresses, networks, etc.
  Ex: scanme.nmap.org, microsoft.com/24, 192.168.0.1; 10.0.0-255.1-254
  -iL <inputfilename>: Input from list of hosts/networks
  -iR <num hosts>: Choose random targets
  --exclude <host1[,host2][,host3],...>: Exclude hosts/networks
  --excludefile <exclude_file>: Exclude list from file
HOST DISCOVERY:
  -sL: List Scan - simply list targets to scan
  -sn: Ping Scan - disable port scan
  -Pn: Treat all hosts as online -- skip host discovery
  -PS/PA/PU/PY[portlist]: TCP SYN/ACK, UDP or SCTP discovery to given ports
  -PE/PP/PM: ICMP echo, timestamp, and netmask request discovery probes
  -PO[protocol list]: IP Protocol Ping
  -n/-R: Never do DNS resolution/Always resolve [default: sometimes]
  --dns-servers <serv1[,serv2],...>: Specify custom DNS servers
  --system-dns: Use OS's DNS resolver
  --traceroute: Trace hop path to each host
SCAN TECHNIQUES:
  -sS/sT/sA/sW/sM: TCP SYN/Connect()/ACK/Window/Maimon scans
  -sU: UDP Scan
  -sN/sF/sX: TCP Null, FIN, and Xmas scans
  --scanflags <flags>: Customize TCP scan flags
  -sI <zombie host[:probeport]>: Idle scan
  -sY/sZ: SCTP INIT/COOKIE-ECHO scans
  -sO: IP protocol scan
  -b <FTP relay host>: FTP bounce scan
PORT SPECIFICATION AND SCAN ORDER:
  -p <port ranges>: Only scan specified ports
    Ex: -p22; -p1-65535; -p U:53,111,137,T:21-25,80,139,8080,S:9
  --exclude-ports <port ranges>: Exclude the specified ports from scanning
  -F: Fast mode - Scan fewer ports than the default scan
  -r: Scan ports consecutively - don't randomize
  --top-ports <number>: Scan <number> most common ports
  --port-ratio <ratio>: Scan ports more common than <ratio>
SERVICE/VERSION DETECTION:
  -sV: Probe open ports to determine service/version info
  --version-intensity <level>: Set from 0 (light) to 9 (try all probes)
  --version-light: Limit to most likely probes (intensity 2)
  --version-all: Try every single probe (intensity 9)
  --version-trace: Show detailed version scan activity (for debugging)
SCRIPT SCAN:
  -sC: equivalent to --script=default
  --script=<Lua scripts>: <Lua scripts> is a comma separated list of
           directories, script-files or script-categories
  --script-args=<n1=v1,[n2=v2,...]>: provide arguments to scripts
  --script-args-file=filename: provide NSE script args in a file
  --script-trace: Show all data sent and received
  --script-updatedb: Update the script database.
  --script-help=<Lua scripts>: Show help about scripts.
           <Lua scripts> is a comma-separated list of script-files or
           script-categories.
OS DETECTION:
  -O: Enable OS detection
  --osscan-limit: Limit OS detection to promising targets
  --osscan-guess: Guess OS more aggressively
TIMING AND PERFORMANCE:
  Options which take <time> are in seconds, or append 'ms' (milliseconds),
  's' (seconds), 'm' (minutes), or 'h' (hours) to the value (e.g. 30m).
  -T<0-5>: Set timing template (higher is faster)
  --min-hostgroup/max-hostgroup <size>: Parallel host scan group sizes
  --min-parallelism/max-parallelism <numprobes>: Probe parallelization
  --min-rtt-timeout/max-rtt-timeout/initial-rtt-timeout <time>: Specifies
      probe round trip time.
  --max-retries <tries>: Caps number of port scan probe retransmissions.
  --host-timeout <time>: Give up on target after this long
  --scan-delay/--max-scan-delay <time>: Adjust delay between probes
  --min-rate <number>: Send packets no slower than <number> per second
  --max-rate <number>: Send packets no faster than <number> per second
FIREWALL/IDS EVASION AND SPOOFING:
  -f; --mtu <val>: fragment packets (optionally w/given MTU)
  -D <decoy1,decoy2[,ME],...>: Cloak a scan with decoys
  -S <IP_Address>: Spoof source address
  -e <iface>: Use specified interface
  -g/--source-port <portnum>: Use given port number
  --proxies <url1,[url2],...>: Relay connections through HTTP/SOCKS4 proxies
  --data <hex string>: Append a custom payload to sent packets
  --data-string <string>: Append a custom ASCII string to sent packets
  --data-length <num>: Append random data to sent packets
  --ip-options <options>: Send packets with specified ip options
  --ttl <val>: Set IP time-to-live field
  --spoof-mac <mac address/prefix/vendor name>: Spoof your MAC address
  --badsum: Send packets with a bogus TCP/UDP/SCTP checksum
OUTPUT:
  -oN/-oX/-oS/-oG <file>: Output scan in normal, XML, s|<rIpt kIddi3,
     and Grepable format, respectively, to the given filename.
  -oA <basename>: Output in the three major formats at once
  -v: Increase verbosity level (use -vv or more for greater effect)
  -d: Increase debugging level (use -dd or more for greater effect)
  --reason: Display the reason a port is in a particular state
  --open: Only show open (or possibly open) ports
  --packet-trace: Show all packets sent and received
  --iflist: Print host interfaces and routes (for debugging)
  --append-output: Append to rather than clobber specified output files
  --resume <filename>: Resume an aborted scan
  --stylesheet <path/URL>: XSL stylesheet to transform XML output to HTML
  --webxml: Reference stylesheet from Nmap.Org for more portable XML
  --no-stylesheet: Prevent associating of XSL stylesheet w/XML output
MISC:
  -6: Enable IPv6 scanning
  -A: Enable OS detection, version detection, script scanning, and traceroute
  --datadir <dirname>: Specify custom Nmap data file location
  --send-eth/--send-ip: Send using raw ethernet frames or IP packets
  --privileged: Assume that the user is fully privileged
  --unprivileged: Assume the user lacks raw socket privileges
  -V: Print version number
  -h: Print this help summary page.
EXAMPLES:
  nmap -v -A scanme.nmap.org
  nmap -v -sn 192.168.0.0/16 10.0.0.0/8
  nmap -v -iR 10000 -Pn -p 80
SEE THE MAN PAGE (https://nmap.org/book/man.html) FOR MORE OPTIONS AND EXAMPLES
```


## 8. UDP Scan

### Nmap

* -sU: UDP scan

```
root@kali:~# nmap -sU [host]
root@kali:~# nmap -sU 192.168.0.104
root@kali:~# nmap -v -sU -Pn 192.168.0.104
root@kali:~# nmap -v -sU -p 161 192.168.0.104
```

* -sUV: UDP scan, service scan

```
root@kali:~# nmap -sUV [host]
root@kali:~# nmap -sU 192.168.0.104
root@kali:~# nmap -v -sUV -Pn -p 53,162,161,5060 192.168.0.104
```

## 9. Networking Sweeping

```
root@kali:~# nmap -v -sn 192.168.0.1/24 -oG hosts.txt
root@kali:~# grep Up hosts.txt
root@kali:~# grep Up hosts.txt | cut -d" " -f2 >> live-hosts.txt
root@kali:~# nmap -v -sS -p 80 -Pn -iL live-hosts.txt
root@kali:~# nmap -v -sS -p 80 --open -Pn -iL live-hosts.txt -oG web.txt
root@kali:~# nmap -v -sS -p 22 --open -Pn -iL live-hosts.txt -oG ssh.txt
root@kali:~# nmap -v -sS -p http* --open -Pn -iL live-hosts.txt -oG http.txt
root@kali:~# nmap -v -sS --top-ports=20 --open -Pn -iL live-hosts.txt -oG top-ports-20.txt
```

## 10. Search Services

#### -sV

Probe open ports to determine service/version info.

> nmap -v -sV [host IP]

```
root@kali:~# nmap -v -sV -Pn 10.0.1.1
```

#### -A

Enable OS detection, version detection, script scanning, and traceroute.

> nmap -v -A [host IP]

```
root@kali:~# nmap -v -A -Pn 10.0.1.1
```

## 11. Banner Grabbing

> nc -v [host IP] [port]

```
root@kali:~# nc -v 10.0.0.1 21
Connection to 10.0.0.1 21 port [tcp/ftp] succeeded!
220 (vsFTPd 2.3.4)

root@kali:~# nc -v 10.0.0.1 22
Connection to 10.0.0.1 22 port [tcp/ftp] succeeded!
SSH-2.0-OpenSSH_4.7p1 Debian-8ubuntu1

```

## 11. Netcat Portsacan

> nc -vn -z -w[sec] [host IP] [port/port range]

* -v: verbose [use twice to be more verbose]
* -n: numeric-only IP addresses, no DNS
* -z: zero-I/O mode [used for scanning]
* -w [secs]: timeout for connects and final net reads

```
root@kali:~# nc -vn -z -w2 10.0.0.1 20-81
```

* -u: UDP mode

```
root@kali:~# nc -vnu -z -w2 10.0.0.1 160-162
```

## 12. OS Discovery

#### -O

Enable OS detection, compare ttl, services, etc.

![ttl-table](http://resources.infosecinstitute.com/wp-content/uploads/032014_1419_OverviewofO9.png)
<br>

* **ttl info**: /proc/sys/net/ipv4/ip_default_ttl

> nmap -O [host IP]

```
root@kali:~# nmap -O -Pn 10.0.0.1
```

## Firewall bypass

##### firewall.zip

```
```